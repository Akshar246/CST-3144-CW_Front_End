<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutoring App</title>
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
  <script src="products.js"></script>
</head>

<body>
  <div id="app">
    <h1 v-text="siteName"></h1>

    <!-- Checkout Page -->
    <main class="checkout-page" v-if="currentView === 'checkout'">
      <h2 class="checkout-heading">Checkout Page</h2>
      <div v-if="cart.length > 0">
        <ul class="cart-items">
          <li class="cart-item" v-for="item in cart" :key="item.cartId">
            <img class="figure" :src="item.image" alt="Lesson Image" style="width: 100px; height: auto" />
            <br />
            <strong>Name:</strong> {{ item.name }} <br />
            <strong>Subject:</strong> {{ item.name }} <br />
            <strong>Price:</strong> {{ item.price }} <br />
            <strong>Location:</strong> {{ item.location }} <br />
            <button v-on:click="removeFromCart(item)">Remove</button>
          </li>
        </ul>

        <!-- Form for User Details -->
        <h2 class="checkout-heading">Enter Your Details</h2>
        <form @submit.prevent="submitOrder" class="checkout-form">
          <div class="form-group">
            <label for="name" class="form-label">Name:</label>
            <input type="text" v-model="customerName" class="form-input" required />
          </div>
          <div class="form-group">
            <label for="phone" class="form-label">Phone:</label>
            <input type="tel" v-model.number="customerPhone" class="form-input" required />
          </div>
          <button type="submit" class="submit-button">Submit Order</button>
        </form>
      </div>
      <div v-else="">
        <h2>Your Cart Is Empty</h2>
        <button class="back-button" v-on:click="backToProductList">
          Back To Product List
        </button>
      </div>
    </main>

    <!-- Product List Page -->
    <main v-if="currentView === 'productList'">
      <div class="main-content" v-for="product in products" :key="product.id">
        <figure>
          <img class="figure" v-bind:src="product.image" alt="" />
        </figure>
        <div class="Maths-content">
          <strong>Subject: {{ product.name }}<br /></strong>
          <strong>Location: {{ product.location }}<br /></strong>
          <strong>Price: {{ product.price }}<br /></strong>
          <strong>Spaces: {{ itemsLeft(product) }}<br /></strong>
          <button class="add-to-cart" :class="{'disabled-button': itemsLeft(product) === 0}"
            v-on:click="addToCart(product)" :disabled="itemsLeft(product) === 0">
            Add to cart
          </button>
          <span v-if="itemsLeft(product) === 0"><b> All out!</b></span>
          <span v-else-if="itemsLeft(product) < 5">
            <b>Only {{ itemsLeft(product) }} spaces left!</b>
          </span>
          <span v-else><b>Buy now!!</b></span>
          <!-- Rating Section -->
          <div>
            <span v-for="n in product.rating || 0" :key="'filled-' + n">
              <i class="fa-solid fa-star"></i>
            </span>
            <span v-for="n in (5 - (product.rating || 0))" :key="'empty-' + n">
              <i class="fa-regular fa-star"></i>
            </span>
          </div>
        </div>
      </div>
    </main>

    <!-- Checkout Button -->
    <button class="checkout" v-on:click="goToCheckout" :disabled="isCheckoutButtonDisabled">
      {{ cartItemCount }} <span class="fas fa-cart-plus"></span> Checkout
    </button>
  </div>

  <script type="text/javascript">
    var lessonApp = new Vue({
      el: "#app",
      data: {
        siteName: "Tutoring App",
        products: [], // Initially empty, fetched from backend
        cart: [],
        customerName: "",
        customerPhone: "",
        currentView: "productList",
      },
      computed: {
        cartItemCount: function () {
          return this.cart.length || "";
        },
        isCheckoutButtonDisabled: function () {
          return this.cart.length === 0;
        },
      },
      methods: {
        async fetchLessons() {
          try {
            const response = await fetch(
              "http://localhost:3000/api/products"
            );
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            this.products = data;
          } catch (error) {
            console.error("Error fetching lessons:", error);
          }
        },
        async saveOrder(order) {
          try {
            const response = await fetch("http://localhost:3000/api/orders", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(order),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to save order: ${errorText}`);
            }

            const result = await response.json();
            return result.orderId;
          } catch (error) {
            console.error("Error saving order:", error);
            throw error;
          }
        },

        addToCart(product) {
          if (this.itemsLeft(product) > 0) {
            const cartItem = {
              ...product,
              cartId: Date.now() + Math.random(),
            };
            this.cart.push(cartItem);
            alert(`Added ${product.name} to cart`);
          } else {
            alert("No more spaces available for this lesson.");
          }
        },
        removeFromCart(product) {
          const index = this.cart.findIndex(
            (item) => item.cartId === product.cartId
          );
          if (index !== -1) {
            this.cart.splice(index, 1);
          }
        },
        itemsLeft(product) {
          const countInCart = this.cart.filter(
            (item) => item.id === product.id
          ).length;
          return product.availableSpaces - countInCart;
        },
        goToCheckout() {
          if (this.cart.length > 0) {
            this.currentView = "checkout";
          }
        },
        backToProductList() {
          this.currentView = "productList";
        },
      },
      mounted() {
        this.fetchLessons();
      },
    });
  </script>
</body>

</html>
